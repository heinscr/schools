# API Authentication

## Overview

The API uses API key authentication to protect write operations (POST, PUT, DELETE). Read operations (GET) remain publicly accessible.

## Protected Endpoints

The following endpoints require authentication:

- `POST /api/districts` - Create a new district
- `PUT /api/districts/{district_id}` - Update a district
- `DELETE /api/districts/{district_id}` - Delete a district

## Public Endpoints

All GET endpoints are public and do not require authentication:

- `GET /api/districts` - List all districts
- `GET /api/districts/search` - Search districts
- `GET /api/districts/{district_id}` - Get a specific district
- `GET /api/salary-schedule/{district_id}` - Get salary schedules
- `GET /api/salary-compare` - Compare salaries
- `GET /api/salary-heatmap` - Get salary heatmap
- `GET /api/districts/{district_id}/salary-metadata` - Get salary metadata

## How to Use

### 1. API Key Generation (Automated)

The API key is **automatically generated by Terraform** when you provision the infrastructure. You don't need to manually generate it.

The key is:
- Generated using Terraform's `random_password` provider (cryptographically secure)
- Stored in Terraform state (ensure state is secured!)
- Automatically injected into the Lambda function environment variables

### 2. Retrieve the API Key

#### For Production (Deployed Infrastructure)

Get the API key from Terraform:

```bash
cd infrastructure/terraform
terraform output -raw api_key
```

This will display the auto-generated API key.

#### For Local Development

You can either:

**Option A: Use the production Terraform-managed key (Recommended)**
```bash
# Get the key from Terraform and add to .env
cd infrastructure/terraform
echo "API_KEY=$(terraform output -raw api_key)" >> ../backend/.env
```

**Option B: Set your own key for local testing**

Add to your `backend/.env` file:

```env
API_KEY=your-local-test-key
```

Generate a local test key:
```bash
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

### 3. Making Authenticated Requests

Include the API key in the `X-API-Key` header:

#### cURL Example

```bash
curl -X POST https://school.crackpow.com/api/districts \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key-here" \
  -d '{
    "name": "Example District",
    "district_type": "municipal",
    "towns": ["Boston"],
    "main_address": "123 Main St"
  }'
```

#### JavaScript/Fetch Example

```javascript
const response = await fetch('https://school.crackpow.com/api/districts', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-API-Key': 'your-api-key-here'
  },
  body: JSON.stringify({
    name: 'Example District',
    district_type: 'municipal',
    towns: ['Boston'],
    main_address: '123 Main St'
  })
});
```

#### Python Example

```python
import requests

headers = {
    'Content-Type': 'application/json',
    'X-API-Key': 'your-api-key-here'
}

data = {
    'name': 'Example District',
    'district_type': 'municipal',
    'towns': ['Boston'],
    'main_address': '123 Main St'
}

response = requests.post(
    'https://school.crackpow.com/api/districts',
    headers=headers,
    json=data
)
```

## Error Responses

### 401 Unauthorized - Missing API Key

```json
{
  "detail": "API key required for this operation"
}
```

### 403 Forbidden - Invalid API Key

```json
{
  "detail": "Invalid API key"
}
```

### 500 Internal Server Error - API Key Not Configured

```json
{
  "detail": "API authentication not configured"
}
```

## Security Best Practices

1. **Keep your API key secret** - Never commit it to version control
2. **Terraform manages the key** - The key is auto-generated and stored in Terraform state
3. **Secure your Terraform state** - Use a remote backend (S3 with encryption) for production
4. **Rotate keys when needed** - Use `terraform taint random_password.api_key` then `terraform apply` to generate a new key
5. **Use HTTPS only** - Never send API keys over unencrypted connections
6. **Monitor usage** - Check Lambda CloudWatch logs for unauthorized access attempts
7. **Access control** - Limit who can run `terraform output` and access the state file

## Key Rotation

To rotate the API key:

```bash
cd infrastructure/terraform
terraform taint random_password.api_key
terraform apply
```

This will generate a new API key and update the Lambda function automatically. The deployment script will pick up the new key on the next deploy.
