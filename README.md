# Massachusetts Teachers Contracts Lookup

A comprehensive web application for exploring Massachusetts school districts and teacher salary schedules. Features interactive mapping, salary comparison tools, and detailed district information across all 356 Massachusetts public school districts.

## Project Structure

```
schools/
├── backend/                      # Python FastAPI backend (Lambda)
│   ├── main.py                   # API entry point with all endpoints
│   ├── database.py               # DynamoDB client
│   ├── schemas.py                # Pydantic validation schemas
│   ├── models.py                 # Data models
│   ├── config.py                 # Configuration management
│   ├── cognito_auth.py           # AWS Cognito authentication
│   ├── rate_limiter.py           # SlowAPI rate limiting
│   ├── validation.py             # Input validation utilities
│   ├── error_handlers.py         # Centralized error handling
│   ├── services/
│   │   ├── dynamodb_district_service.py  # District CRUD operations
│   │   ├── salary_service.py             # Salary schedule queries
│   │   ├── salary_jobs.py                # Salary upload/processing jobs
│   │   ├── contract_processor.py         # PDF contract processing
│   │   ├── hybrid_extractor.py           # Multi-method PDF extraction
│   │   └── table_extractor.py            # Table parsing utilities
│   ├── lambdas/
│   │   ├── processor.py          # SQS-triggered PDF extraction Lambda
│   │   └── normalizer.py         # Global salary normalization Lambda
│   ├── utils/
│   │   ├── dynamodb.py           # DynamoDB utilities
│   │   ├── responses.py          # Response formatters
│   │   ├── serialization.py      # JSON serialization
│   │   └── normalization.py      # Data normalization logic
│   ├── scripts/
│   │   ├── import_districts.py   # Import districts to DynamoDB
│   │   ├── load_salary_data.py   # Import salary schedules
│   │   └── normalize_salaries.py # Normalize and validate data
│   ├── tests/                    # Pytest test suite (14 test files)
│   ├── requirements.txt          # Python dependencies
│   ├── requirements-dev.txt      # Development dependencies
│   └── .env                      # Auto-generated by Terraform
│
├── data/                         # District and map data
│   ├── districts.json            # 356 MA district metadata
│   ├── all_districts.json        # Complete unfiltered dataset
│   ├── salary_data.example.json  # Salary schedule example
│   ├── geojson.json              # MA town boundaries (GeoJSON)
│   ├── dese_org_codes.json       # DESE organization codes
│   ├── sample_contracts/         # Sample PDF contracts for testing
│   └── README.md                 # Data documentation
│
├── docs/                         # Documentation
│   ├── README.md                 # Documentation index
│   ├── QUICK_START.md
│   ├── DEPLOYMENT_GUIDE.md
│   ├── INFRASTRUCTURE.md
│   ├── DYNAMODB_SETUP.md
│   ├── CUSTOM_DOMAIN_SETUP.md
│   ├── AUTHENTICATION.md
│   ├── SALARY_API_SETUP.md
│   ├── SALARY_DATA_DESIGN.md
│   └── TERRAFORM_IMPROVEMENTS.md
│
├── frontend/                     # React + Vite SPA
│   ├── src/
│   │   ├── components/
│   │   │   ├── DistrictBrowser.jsx      # District list & search
│   │   │   ├── DistrictEditor.jsx       # Admin district editing
│   │   │   ├── SalaryComparison.jsx     # Salary comparison tool
│   │   │   ├── SalaryComparisonMap.jsx  # Choropleth heat map
│   │   │   ├── ChoroplethMap.jsx        # D3-based map component
│   │   │   ├── SalaryTable.jsx          # Salary data table display
│   │   │   ├── CustomSalaryFilter.jsx   # Filter UI controls
│   │   │   ├── SalaryUploadModal.jsx    # PDF upload interface
│   │   │   ├── Login.jsx                # Cognito authentication
│   │   │   ├── LoadingOverlay.jsx       # Loading state component
│   │   │   ├── Toast.jsx                # Notification component
│   │   │   ├── ConfirmDialog.jsx        # Confirmation dialogs
│   │   │   ├── BackupManager.jsx        # Data backup utilities
│   │   │   ├── ErrorBoundary.jsx        # Error handling
│   │   │   └── README.md                # Component documentation
│   │   ├── contexts/
│   │   │   └── DataCacheContext.jsx     # Client-side caching
│   │   ├── services/
│   │   │   ├── api.js            # API client
│   │   │   └── auth.js           # Cognito authentication service
│   │   ├── hooks/
│   │   │   └── useDataCache.js   # Cache hook
│   │   ├── utils/
│   │   │   ├── formatters.js     # Formatting utilities
│   │   │   ├── logger.js         # Logging utility
│   │   │   └── sortDistricts.js  # Sorting utilities
│   │   ├── constants/
│   │   │   └── districtTypes.js  # District type constants
│   │   ├── App.jsx               # Main application
│   │   ├── main.jsx              # Entry point
│   │   └── setupTests.js         # Vitest configuration
│   ├── public/
│   │   └── geojson.json          # Town boundaries (TopoJSON)
│   ├── tests/                    # Vitest test suite
│   ├── package.json
│   ├── vite.config.js
│   ├── .env.example
│   └── README.md                 # Frontend documentation
│
├── infrastructure/
│   ├── terraform/
│   │   ├── main.tf               # Core infrastructure
│   │   ├── cognito.tf            # AWS Cognito user pool
│   │   ├── salary_processing.tf  # SQS queue & Lambda functions
│   │   ├── outputs.tf            # Terraform outputs
│   │   ├── variables.tf          # Variable definitions
│   │   ├── terraform.tfvars.example # Terraform variables example
│   │   ├── placeholder_lambda.tf # Initial Lambda setup
│   │   ├── frontend_config.tf    # Frontend config.json
│   │   └── backend_env.tftpl     # Template for backend/.env
│   └── scripts/
│       ├── deploy-backend-tf.sh  # Deploy backend code
│       └── deploy-frontend-tf.sh # Deploy frontend code
│
├── scripts/                      # PDF extraction & testing scripts
│   ├── scrape_contracts.py       # Contract scraping from web
│   ├── process_s3_contracts.py   # S3-based contract processing
│   ├── test_extraction.py        # PDF extraction testing
│   ├── debug_pdf.py              # PDF debugging utilities
│   ├── import_problem_districts.py # Import problematic districts
│   └── test_year_patterns.py     # Year pattern extraction tests
│
├── deploy.sh                     # Main deployment script
├── deploy-simple.sh              # Simplified deployment wrapper
├── recreate.sh                   # Full infrastructure recreation
├── dev.sh                        # Local development startup
├── SALARY_PROCESSING_IMPLEMENTATION.md # Salary processing architecture
├── PYMUPDF_INTEGRATION.md        # PyMuPDF extraction integration
├── LICENSE                       # MIT License
└── README.md
```

## Quick Start

### Local Development

**Backend:**
```bash
cd backend
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn main:app --reload
```
API available at `http://localhost:8000`

**Frontend:**
```bash
cd frontend
npm install
npm run dev
```
Website available at `http://localhost:5173`

### AWS Deployment

**Quick Recreation (One Command)**

For recreating the entire infrastructure from scratch:
```bash
./recreate.sh
```

This script will:
1. Initialize and apply Terraform configuration
2. Optionally create an admin Cognito user (with prompts for email/password)
3. Deploy the application (backend + frontend)
4. Import district and salary data

**Manual Deployment (Step by Step)**

**Step 1: Initialize Terraform**
```bash
cd infrastructure/terraform
terraform init
```

**Step 2: Configure variables**
```bash
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your values
```

**Step 3: Deploy infrastructure**
```bash
terraform apply
```

**Step 4: Deploy application code**
```bash
cd ../../
./deploy.sh
```

The deploy script will:
- Package and upload Lambda backend code
- Build frontend with correct API endpoint from Terraform
- Upload frontend to S3
- Invalidate CloudFront cache

**Step 5: Import district data (optional)**
```bash
cd backend
source venv/bin/activate
python import_districts.py --file ../data/districts.json
```

See [docs/DEPLOYMENT_GUIDE.md](docs/DEPLOYMENT_GUIDE.md) for detailed deployment instructions.

## Architecture

### Unified Lambda Architecture
The application uses a **single Lambda function** serving all API endpoints through FastAPI:
- **District API** - CRUD operations, search, filtering
- **Salary API** - Schedule queries, comparisons, heat map data
- **Auth API** - Cognito JWT validation, user info

All endpoints route through API Gateway's `{proxy+}` resource to the main Lambda, which handles CORS, rate limiting, validation, and error handling centrally.

### Technology Stack

**Backend:**
- **Python 3.12** - Runtime
- **FastAPI** - Web framework with automatic OpenAPI docs
- **Mangum** - AWS Lambda adapter for ASGI
- **DynamoDB** - NoSQL database (single-table design)
- **Boto3** - AWS SDK for Python
- **Pydantic** - Request/response validation
- **SlowAPI** - Rate limiting middleware
- **AWS Cognito** - User authentication (JWT)
- **Pytest** - Testing framework

**Frontend:**
- **React 18** - UI library with hooks
- **Vite 4.5** - Build tool and dev server
- **D3.js 7.9** - Data visualization for choropleth maps
- **TopoJSON** - Compressed geographic data format
- **Vitest** - Testing framework with React Testing Library
- **amazon-cognito-identity-js** - AWS Cognito authentication
- **CSS3** - Component-scoped styling

**Infrastructure (AWS):**
- **Terraform** - Infrastructure as Code
- **Lambda** - Serverless compute (Python 3.12) - Main API, PDF processor, normalizer
- **API Gateway** - REST API with proxy integration
- **DynamoDB** - Managed NoSQL with GSIs and TTL
- **S3** - Frontend hosting, Lambda packages, contract PDFs
- **SQS** - Asynchronous salary processing queue
- **CloudFront** - CDN with custom domain support
- **AWS Cognito** - User pool and authentication
- **Route 53** - DNS management (optional, external)
- **ACM** - SSL certificates
- **IAM** - Fine-grained permissions

## Features

### Currently Implemented ✅

**District Management:**
- Browse all 356 Massachusetts school districts
- Search by district name or town
- View district details (address, contact, DESE org code)
- Admin editing with Cognito authentication
- Geocoded locations for mapping

**Salary Comparison Tool:**
- Compare teacher salaries across districts
- Interactive filters: education level, credits, years of experience
- Target salary highlighting in comparison table
- Visual indicators for calculated/interpreted values
- Up to 5 districts comparison simultaneously
- Fallback matching for missing education/credit combinations

**Interactive Mapping:**
- **Choropleth Heat Map** - Color-coded salary visualization by town
- **District Locations** - OpenStreetMap with Leaflet markers
- **Town Boundaries** - GeoJSON-based town highlighting
- **Smart Geocoding** - Automatic coordinate lookup with fallbacks

**Authentication & Security:**
- AWS Cognito user pool integration
- JWT-based authentication
- Role-based access control (admin role)
- Rate limiting (SlowAPI)
- CORS protection
- Input validation and sanitization

**Data Management:**
- Single-table DynamoDB design with GSIs
- Salary schedule storage (by district, year, period)
- Metadata tracking (availability, max values)
- Intelligent fallback query system
- Automated data normalization scripts
- TTL-based job cleanup (30 days)

**PDF Processing & Upload (Admin):**
- Upload teacher salary PDFs directly through web interface
- Multi-method extraction: pdfplumber → PyMuPDF → AWS Textract fallback
- Asynchronous job processing via SQS and Lambda
- Preview extracted data before applying to database
- Re-apply previously extracted data with history tracking
- Job status tracking with detailed error reporting

**API Features:**
- RESTful API with OpenAPI documentation
- Comprehensive error handling
- Request validation with Pydantic
- JSON serialization for DynamoDB Decimal types
- Rate limiting: 100/min general, 30/min search, 20/min write

## API Endpoints

**Districts:**
- `GET /api/districts` - List all districts (paginated)
- `GET /api/districts/search` - Search districts by name/town
- `GET /api/districts/{id}` - Get district details
- `POST /api/districts` - Create district (admin)
- `PUT /api/districts/{id}` - Update district (admin)
- `DELETE /api/districts/{id}` - Delete district (admin)

**Salary Schedules:**
- `GET /api/salary-schedule/{district_id}` - Get salary schedule
- `GET /api/salary-schedule/{district_id}/{year}` - Get specific year
- `GET /api/salary-compare` - Compare salaries across districts
- `GET /api/salary-heatmap` - Heat map data for visualization
- `GET /api/salary-metadata` - Available years/periods across all districts
- `GET /api/districts/{id}/salary-metadata` - Available data for district

**Salary Upload & Processing (Admin):**
- `POST /api/admin/districts/{district_id}/salary-schedule/upload` - Upload PDF contract
- `GET /api/admin/districts/{district_id}/salary-schedule/jobs/{job_id}` - Get job status
- `PUT /api/admin/districts/{district_id}/salary-schedule/apply/{job_id}` - Apply extracted data
- `DELETE /api/admin/districts/{district_id}/salary-schedule/jobs/{job_id}` - Reject job

**Global Normalization (Admin):**
- `GET /api/admin/global/normalization/status` - Check normalization status
- `POST /api/admin/global/normalize` - Start global salary normalization

**Authentication:**
- `GET /api/auth/me` - Get current user info (requires JWT)

**Health:**
- `GET /` - API root
- `GET /health` - Health check

Interactive API documentation available at `/docs` (Swagger UI) and `/redoc` when running locally.

## Documentation

- **[Documentation Index](docs/README.md)** - Complete documentation hub
- **[Quick Start](docs/QUICK_START.md)** - Development setup
- **[Deployment Guide](docs/DEPLOYMENT_GUIDE.md)** - Production deployment
- **[Infrastructure Guide](docs/INFRASTRUCTURE.md)** - Architecture details
- **[DynamoDB Setup](docs/DYNAMODB_SETUP.md)** - Database design
- **[Salary API Setup](docs/SALARY_API_SETUP.md)** - Salary data management
- **[Authentication](docs/AUTHENTICATION.md)** - Cognito setup
- **[Custom Domain](docs/CUSTOM_DOMAIN_SETUP.md)** - SSL/DNS configuration
- **[Terraform Guide](docs/TERRAFORM_IMPROVEMENTS.md)** - IaC best practices

## Development

### Backend Development
**Key Files:**
- [backend/main.py](backend/main.py) - FastAPI app with all endpoints
- [backend/services/dynamodb_district_service.py](backend/services/dynamodb_district_service.py) - District operations
- [backend/services/salary_service.py](backend/services/salary_service.py) - Salary queries with fallback logic
- [backend/cognito_auth.py](backend/cognito_auth.py) - JWT authentication
- [backend/rate_limiter.py](backend/rate_limiter.py) - Rate limiting configuration
- [backend/schemas.py](backend/schemas.py) - Pydantic models
- [backend/database.py](backend/database.py) - DynamoDB client

**Testing:**
```bash
cd backend
pytest                    # Run all tests
pytest -v                 # Verbose output
pytest tests/test_main.py # Run specific test file
```

### Frontend Development
**Key Files:**
- [frontend/src/App.jsx](frontend/src/App.jsx) - Main app component
- [frontend/src/components/DistrictBrowser.jsx](frontend/src/components/DistrictBrowser.jsx) - District list/search
- [frontend/src/components/SalaryComparison.jsx](frontend/src/components/SalaryComparison.jsx) - Salary comparison UI
- [frontend/src/components/SalaryComparisonMap.jsx](frontend/src/components/SalaryComparisonMap.jsx) - Choropleth heat map
- [frontend/src/components/ChoroplethMap.jsx](frontend/src/components/ChoroplethMap.jsx) - D3 map visualization
- [frontend/src/components/SalaryUploadModal.jsx](frontend/src/components/SalaryUploadModal.jsx) - PDF upload interface
- [frontend/src/services/api.js](frontend/src/services/api.js) - API client
- [frontend/src/services/auth.js](frontend/src/services/auth.js) - Cognito authentication

**Testing:**
```bash
cd frontend
npm test                  # Run tests in watch mode
npm run test:coverage     # Generate coverage report
```

### Infrastructure Management
**Terraform Commands:**
```bash
cd infrastructure/terraform
terraform init            # Initialize providers
terraform plan            # Preview changes
terraform apply           # Deploy infrastructure
terraform destroy         # Tear down infrastructure
terraform output          # View outputs
```

**Configuration:**
- Infrastructure code: [infrastructure/terraform/main.tf](infrastructure/terraform/main.tf)
- Cognito setup: [infrastructure/terraform/cognito.tf](infrastructure/terraform/cognito.tf)
- Variables: `terraform.tfvars` (gitignored, see `terraform.tfvars.example`)
- Backend .env template: [infrastructure/terraform/backend_env.tftpl](infrastructure/terraform/backend_env.tftpl)

### Deployment Scripts
```bash
./recreate.sh            # Full recreation from scratch (Terraform + deploy + data import)
./deploy.sh              # Deploy code changes only (updates Lambda + frontend)
./deploy.sh --no-tests   # Skip test suite
./dev.sh                 # Start local development (backend + frontend)
```

## Data Management

### Importing Districts
```bash
cd backend
source venv/bin/activate
python scripts/import_districts.py
```

### Loading Salary Data
```bash
cd backend
source venv/bin/activate
python scripts/load_salary_data.py ../data/salary_data.json
```

The script will:
1. Load salary schedules from JSON
2. Store in DynamoDB with proper keys
3. Automatically normalize data (create fallback entries)
4. Update metadata tracking

### Normalizing Existing Data
```bash
cd backend
source venv/bin/activate
python scripts/normalize_salaries.py
```

This creates fallback entries for missing education/credit combinations.

## Configuration Management

**Terraform-Managed:**
- All infrastructure resources (Lambda, API Gateway, DynamoDB, S3, CloudFront, Cognito)
- Lambda environment variables (CUSTOM_DOMAIN, CLOUDFRONT_DOMAIN, Cognito config)
- Backend `.env` file generation (via `backend_env.tftpl` template)

**Manual Configuration:**
- `terraform.tfvars` - Set AWS region, project name, custom domain
- Cognito admin user creation (via `recreate.sh` prompts or AWS CLI)

**Environment Variables:**
- Lambda: Managed by Terraform in [main.tf](infrastructure/terraform/main.tf:386-399)
- Local backend: Auto-generated at `backend/.env` by Terraform
- Frontend: Build-time via `VITE_` prefixed vars, runtime via `config.json`

## License

MIT License - See [LICENSE](LICENSE) file for details